From 1aa3b85d23a821cd06bd7708f489862f85823f11 Mon Sep 17 00:00:00 2001
From: Novakov <maciejt.nowak@gmail.com>
Date: Sat, 13 Feb 2016 20:06:43 +0100
Subject: [PATCH] Allow mocking file system (getcmd & mkdir)

---
 googletest/include/gtest/internal/gtest-port.h |  5 ++++-
 googletest/src/gtest-filepath.cc               | 16 +++++++++++++---
 2 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/googletest/include/gtest/internal/gtest-port.h b/googletest/include/gtest/internal/gtest-port.h
index 7d6e465..ae7e876 100644
--- a/googletest/include/gtest/internal/gtest-port.h
+++ b/googletest/include/gtest/internal/gtest-port.h
@@ -413,6 +413,10 @@ struct _RTL_CRITICAL_SECTION;
 #  include <android/api-level.h>  // NOLINT
 #endif

+#ifndef GTEST_MOCK_FS
+# define GTEST_MOCK_FS 0
+#endif
+
 // Defines this to true iff Google Test can use POSIX regular expressions.
 #ifndef GTEST_HAS_POSIX_RE
 # if GTEST_OS_LINUX_ANDROID
@@ -2552,4 +2556,3 @@ const char* StringFromGTestEnv(const char* flag, const char* default_val);
 }  // namespace testing

 #endif  // GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PORT_H_
-
diff --git a/googletest/src/gtest-filepath.cc b/googletest/src/gtest-filepath.cc
index 0292dc1..80a08d0 100644
--- a/googletest/src/gtest-filepath.cc
+++ b/googletest/src/gtest-filepath.cc
@@ -97,7 +97,9 @@ static bool IsPathSeparator(char c) {

 // Returns the current working directory, or "" if unsuccessful.
 FilePath FilePath::GetCurrentDir() {
-#if GTEST_OS_WINDOWS_MOBILE || GTEST_OS_WINDOWS_PHONE || GTEST_OS_WINDOWS_RT
+#if GTEST_MOCK_FS == 1
+  return FilePath(kCurrentDirectoryString);
+#elif GTEST_OS_WINDOWS_MOBILE || GTEST_OS_WINDOWS_PHONE || GTEST_OS_WINDOWS_RT
   // Windows CE doesn't have a current directory, so we just return
   // something reasonable.
   return FilePath(kCurrentDirectoryString);
@@ -264,7 +266,9 @@ bool FilePath::IsRootDirectory() const {
 // Returns true if pathname describes an absolute path.
 bool FilePath::IsAbsolutePath() const {
   const char* const name = pathname_.c_str();
-#if GTEST_OS_WINDOWS
+#if GTEST_MOCK_FS == 1
+  return true;
+#elif GTEST_OS_WINDOWS
   return pathname_.length() >= 3 &&
      ((name[0] >= 'a' && name[0] <= 'z') ||
       (name[0] >= 'A' && name[0] <= 'Z')) &&
@@ -306,6 +310,10 @@ bool FilePath::IsDirectory() const {
 // the directories already exist; returns false if unable to create directories
 // for any reason.
 bool FilePath::CreateDirectoriesRecursively() const {
+#if GTEST_MOCK_FS == 1
+  return true;
+#endif
+  printf("CreateDirectoriesRecursively %s\n", this->c_str());
   if (!this->IsDirectory()) {
     return false;
   }
@@ -323,7 +331,9 @@ bool FilePath::CreateDirectoriesRecursively() const {
 // directory for any reason, including if the parent directory does not
 // exist. Not named "CreateDirectory" because that's a macro on Windows.
 bool FilePath::CreateFolder() const {
-#if GTEST_OS_WINDOWS_MOBILE
+#if GTEST_MOCK_FS == 1
+  int result = 0;
+#elif TEST_OS_WINDOWS_MOBILE
   FilePath removed_sep(this->RemoveTrailingPathSeparator());
   LPCWSTR unicode = String::AnsiToUtf16(removed_sep.c_str());
   int result = CreateDirectory(unicode, NULL) ? 0 : -1;
--
2.6.3.windows.1
